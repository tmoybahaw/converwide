<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Shaka Player Proxy Test</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.9.3/shaka-player.compiled.js"></script>
</head>
<body style="background:#000; margin:0; display:flex; height:100vh; align-items:center; justify-content:center;">
  <video id="video" width="800" controls autoplay></video>

  <script>
    async function init() {
      // Install polyfills
      shaka.polyfill.installAll();
      if (!shaka.Player.isBrowserSupported()) {
        console.error("Browser not supported!");
        return;
      }

      const video = document.getElementById('video');
      const player = new shaka.Player(video);

      // Log errors
      player.addEventListener('error', e => console.error('Shaka Error', e.detail));

      // ðŸš¨ Networking override: force everything through /api/proxy
      const proxyScheme = (uri, request, requestType) => {
        const proxied = "/api/proxy?url=" + encodeURIComponent(uri);
        return shaka.net.HttpPlugin.parse(proxied, request, requestType);
      };

      // Override both HTTP + HTTPS
      shaka.net.NetworkingEngine.registerScheme('http', proxyScheme);
      shaka.net.NetworkingEngine.registerScheme('https', proxyScheme);

      // Replace this with your DASH MPD link
      const manifestUri = "/api/proxy?url=" + encodeURIComponent(
        "https://nanopi.rocket-tv.online/Astro_AOD/default_primary.mpd"
      );

      try {
        await player.load(manifestUri);
        console.log("Loaded:", manifestUri);
      } catch (err) {
        console.error("Load failed:", err);
      }
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
